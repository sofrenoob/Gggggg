
set -euo pipefail

# USO: change_admin_password.sh NOVA_SENHA [USUÁRIO]
if [ $# -lt 1 ]; then
  echo "Uso: $0 NOVA_SENHA [USUÁRIO]" >&2
  exit 1
fi

## CONFIGURE AQUI
APP_DIR="/var/www/alfa_cloud"          # onde está seu projeto
VENV_DIR="$APP_DIR/venv"               # virtualenv
DB_FILE="$APP_DIR/db.sqlite3"          # caminho para o seu SQLite
TABLE="users"                          # tabela de usuários
USERCOL="admin"                     # coluna de login
PASSCOL="admin123"                     # coluna da senha
USERNAME="${2:-admin}"                 # usuário, default "admin"
#########################################

NEWPASS="$1"

# Verifica se o DB existe
if [ ! -f "$DB_FILE" ]; then
  echo "Erro: não achei o DB em $DB_FILE" >&2
  exit 1
fi

# Gera o hash usando o Python do venv
HASH=$(
  source "$VENV_DIR/bin/activate" && \
  python - <<EOF
import os
from werkzeug.security import generate_password_hash
# gere o hash
print(generate_password_hash(os.getenv("NEWPASS")))
EOF
)

# Atualiza o DB
sqlite3 "$DB_FILE" <<SQL
UPDATE $TABLE
   SET $PASSCOL = '$HASH'
 WHERE $USERCOL = '$USERNAME';
SQL

echo "✅ Senha do usuário '$USERNAME' atualizada com sucesso!"
